<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Logging with Bevy</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intoduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Println </a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> Redirecting output to a file</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Dbg</a></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> The log plugin</a></li><li class="chapter-item expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Introduction to Tracing</a></li><li class="chapter-item expanded "><a href="chapter_6.html"><strong aria-hidden="true">6.</strong> Tracing Multiple outputs</a></li><li class="chapter-item expanded "><a href="chapter_7.html"><strong aria-hidden="true">7.</strong> Putting Layers into default plugin</a></li><li class="chapter-item expanded "><a href="future.html"><strong aria-hidden="true">8.</strong> Other features I have thought of using</a></li><li class="chapter-item expanded "><a href="chapter_8.html"><strong aria-hidden="true">9.</strong> Further Info</a></li><li class="chapter-item expanded "><a href="patterns.html"><strong aria-hidden="true">10.</strong> Design patterns</a></li><li class="chapter-item expanded "><a href="subscribers.html"><strong aria-hidden="true">11.</strong> Other Subscribers</a></li><li class="chapter-item expanded "><a href="performance.html"><strong aria-hidden="true">12.</strong> Performance</a></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">13.</strong> Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Logging with Bevy</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<h3 id="about"><a class="header" href="#about">About</a></h3>
<p>I have recently been making a game using the bevy engine.
Along the way I have been helped by community with many issues I have encountered both within the
broader Rust Community as well as the Bevy community.</p>
<h3 id="structure"><a class="header" href="#structure">Structure</a></h3>
<p>As I have spent more time working with Rust, I have moved from using println! to using the tracing crate
for logging.
My Objectives are to</p>
<ul>
<li>Describe the transition from basic methods to more advanced tools.</li>
<li>Explain the reasons that prompted this change in practice.</li>
</ul>
<h3 id="motivation"><a class="header" href="#motivation">Motivation</a></h3>
<p>A common slogan with Rust is "if it compiles it usually works",
however I have found this is not as much the case with Bevy.</p>
<p>While Rust's compile-time checks catch many errors, Bevy's ECS can introduce runtime issues:</p>
<ul>
<li>Queries breaking due to component changes</li>
<li>Systems running in an unexpected order</li>
</ul>
<p>Advanced logging and tracing help catch these issues earlier and provide more context for debugging.</p>
<p>I hope to help the reader fix issues with their games quicker and give something back to the community.</p>
<p>The documentation around Tracing is overwhelming for me and talks a lot about async which I have not used.</p>
<h3 id="what-this-book-is-not"><a class="header" href="#what-this-book-is-not">What this book is not</a></h3>
<p>This book will not talk about debugging tools beyond logging.</p>
<p>Please note this document is not an official document of bevy's</p>
<p>Referenced code can be found <a href="https://github.com/bevy-logging/test_spiral">here</a>
Or you could follow along on your own project.</p>
<h3 id="completion-state"><a class="header" href="#completion-state">Completion state</a></h3>
<p>This book is in a state of generally good enough for my game development.
I prefer to stay on track with my game rather then add to this book,
therefore unless others contribute, updates will appear as they are useful to me.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="println-and-eprintln"><a class="header" href="#println-and-eprintln">Println! and eprintln</a></h1>
<h2 id="println"><a class="header" href="#println">Println!</a></h2>
<p>The first tool which you may reach for when you experience unexpected behaviour is <code>println!</code>.
<code>println!</code> can be used, as the name suggests, to print values at key points of your program where your issue might lie.</p>
<p>However</p>
<ul>
<li>Typing, or more likely copying and pasting <code>println!</code>'s everywhere gets quite tedious.</li>
<li>Each <code>println!</code> should, in most cases, have some marking string that lets you know which one triggered, otherwise you have to do additional searching.</li>
<li>At some point, these <code>println!</code>'s need to be removed, or they will block up the logging.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="redirecting-output-to-a-file"><a class="header" href="#redirecting-output-to-a-file">Redirecting output to a file</a></h1>
<p>You may already know <code>stdout</code> can be redirected to a file using the <code>&gt;</code> operator.
When there is a lot of logging, the screen can fill quickly, so redirecting can help
you manage all that information.</p>
<p>An example below.</p>
<p><code>Cargo run &gt; output.txt</code></p>
<p>This gives you two major benefits</p>
<ul>
<li>You can search in the file</li>
<li>you can use a diff program <sup class="footnote-reference"><a href="#note">1</a></sup> to compare outputs for different executions</li>
</ul>
<div class="footnote-definition" id="note"><sup class="footnote-definition-label">1</sup>
<p>Lots of text editors and IDE's have a built-in diff editor. Alternatively, I use Delta.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dbg-macro"><a class="header" href="#dbg-macro">Dbg macro</a></h1>
<p>The <code>dbg!</code> macro introduced in version <code>1.32</code> is pretty much a <code>println!</code> made for debugging.</p>
<p>An example from the official docs page</p>
<pre><code class="language-rust">let a = 2;
let b = dbg!(a * 2) + 1;
//      ^-- prints: [src/main.rs:2:9] a * 2 = 4
assert_eq!(b, 5);</code></pre>
<p>Notice that the file path and line numbers are printed.
This metadata is generated at compile time, so it will keep up with changes made in your program.</p>
<p>This means it is less essential to make your <code>dbg</code> statements unique.</p>
<p>However, there are still some disadvantages (same as <code>println!</code>)</p>
<ul>
<li>Typing or more likely copying and pasting <code>dbg!</code>'s everywhere gets quite tedious</li>
<li>At some point these <code>dbg!</code>'s need to removed or they will block up the logging</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-log-plugin"><a class="header" href="#the-log-plugin">The log Plugin</a></h1>
<p>One of Bevy's default plugins is the log plugin.</p>
<p>Let's configure the plugin, then explain as we see what happens</p>
<pre><code class="language-rust">fn main() {
    App::new()
        .add_plugins(DefaultPlugins.set(LogPlugin {
            filter: "".to_string(),
            level: Level::TRACE,
            ..Default::default()
        }))
        .add_systems(Startup, setup)
        .run();
}

// The rest of the code...</code></pre>
<p>Code can also be found <a href="https://github.com/bevy-logging/test_spiral">here.</a></p>
<pre><code class="language-rust">use bevy::{log::LogPlugin, prelude::*};
use rand::prelude::*;
use tracing::Level;

//main snip

fn setup(
    mut commands: Commands,
    mut meshes: ResMut&lt;Assets&lt;Mesh&gt;&gt;,
    mut materials: ResMut&lt;Assets&lt;StandardMaterial&gt;&gt;,
) {
    // Camera
    commands.spawn(Camera3dBundle {
        transform: Transform::from_xyz(0.0, 50.0, 100.0).looking_at(Vec3::ZERO, Vec3::Y),
        ..default()
    });

    // Light
    commands.spawn(PointLightBundle {
        point_light: PointLight {
            intensity: 1500.0,
            shadows_enabled: true,
            ..default()
        },
        transform: Transform::from_xyz(4.0, 8.0, 4.0),
        ..default()
    });

    let mut rng = rand::thread_rng();

    // Create spiral galaxy
    for i in 0..10000 {
        let t = i as f32 * 0.005;
        let r = 20.0 * t.sqrt();
        let theta = t * 2.5;

        let x = r * theta.cos();
        let z = r * theta.sin();
        let y = (rng.gen::&lt;f32&gt;() - 0.5) * 2.0; // Add some vertical spread

        let size = (0.05 + rng.gen::&lt;f32&gt;() * 0.1) * (1.0 - t / 50.0); // Smaller stars towards the edge
        let brightness = 1.0 - t / 50.0; // Dimmer stars towards the edge

        let color = Color::srgb(brightness, brightness * 0.8 + 0.2, brightness * 0.6 + 0.4);
        let emissive = Color::srgb(
            brightness * 5.0,
            (brightness * 0.8 + 0.2) * 5.0,
            (brightness * 0.6 + 0.4) * 5.0,
        );

        commands.spawn(PbrBundle {
            mesh: meshes.add(Mesh::from(Sphere { radius: size })),
            material: materials.add(StandardMaterial {
                base_color: color,
                emissive: emissive.into(), // Make stars glow
                ..default()
            }),
            transform: Transform::from_xyz(x, y, z),
            ..default()
        });
    }
}


</code></pre>
<p>Run the code and see what happens.</p>
<pre><code>//snip
2024-10-19T21:46:13.389733Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(1573,1,vk)    
2024-10-19T21:46:13.389739Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389745Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389751Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389757Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389763Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389769Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(6992,1,vk)    
2024-10-19T21:46:13.389774Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(3085,1,vk)    
2024-10-19T21:46:13.389780Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389786Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389792Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389801Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389807Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389813Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(8504,1,vk)    
2024-10-19T21:46:13.389818Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(4597,1,vk)    
2024-10-19T21:46:13.389824Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(690,1,vk)    
2024-10-19T21:46:13.389830Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389836Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389842Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389848Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389854Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389860Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389866Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(6109,1,vk)    
2024-10-19T21:46:13.389872Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) Id(2202,1,vk)    
2024-10-19T21:46:13.389877Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389883Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"    
2024-10-19T21:46:13.389889Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Vertex Buffer"    
2024-10-19T21:46:13.389895Z TRACE wgpu_core::resource: Destroy raw Buffer (dropped) "Mesh Index Buffer"  

</code></pre>
<p>The console is absolutely flooded with debug messages from the Bevy engine itself, along with its dependencies.
Libraries use a similar logging scheme to what is about to be shown below. The idea is that you can filter out the irrelevant logs.
In order to start filtering, we need to learn about levels and the Env filter.</p>
<h2 id="log-levels"><a class="header" href="#log-levels">Log Levels</a></h2>
<p>Tracing (The default Log plugin used for most Bevy Supported platforms with the major exceptions of the web and mobile) has the below log levels from highest (most detailed) to lowest (most important)</p>
<ul>
<li><code>Trace</code> (Not printed by default)</li>
<li><code>Debug</code> (Not printed by default)</li>
<li><code>Info</code> (default level that is printed)</li>
<li><code>Warn</code></li>
<li><code>Error</code></li>
<li><code>None</code> (you turned off logging)</li>
</ul>
<p>It's up to you what these mean exactly, but here is how I use them in Bevy.</p>
<ul>
<li><code>Trace</code> details inside a loop</li>
<li><code>Debug</code> start or end of loops</li>
<li><code>Info</code> usually what I am working on currently, I then set it to either debug or trace. I also use this for information
I want to display but haven't built the UI for yet</li>
<li><code>Warn</code> I never use</li>
<li><code>Error</code> let else fail when I don't expect it to</li>
</ul>
<p>Lower levels are more important, while higher levels (by convention, not enforcement!) are more verbose.</p>
<p>For example, at the default level <code>Info</code> the levels below <code>Warn</code> and <code>Error</code> will also print.</p>
<p>Extract from the Tracing library</p>
<pre><code class="language-rust">use tracing_core::Level;

assert!(Level::TRACE &gt; Level::DEBUG);
assert!(Level::ERROR &lt; Level::WARN);
assert!(Level::INFO &lt;= Level::DEBUG);
assert_eq!(Level::TRACE, Level::TRACE);</code></pre>
<h2 id="env-filter"><a class="header" href="#env-filter">Env Filter</a></h2>
<p>An env filter is used to put specific filters per target, span and fields. For now just equate targets with modules.</p>
<p>Spans will be discussed later.</p>
<p>I have not needed fields, until I use them or someone else supplies an example fields are an excercise for the reader.</p>
<p>To start with let's put a global env filter set all to warn, this can give you useful messages such as a UI-node without an appropriate parent node</p>
<pre><code class="language-rust">fn main() {
    App::new()
        .add_plugins(DefaultPlugins.set(LogPlugin {
            filter: "warn".to_string(),
            level: Level::TRACE,
            ..Default::default()
        }))
        .add_systems(Startup, setup)
        .run();
}</code></pre>
<p>The output in full is</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T22:03:13.935127Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:03:13.944920Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:03:13.944940Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x57584e197e60, name: ?)    
2024-10-19T22:03:13.952153Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:03:13.952167Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
</code></pre>
<h3 id="the-level-field"><a class="header" href="#the-level-field">The level field</a></h3>
<p>The level field in the log plugin is a quick way to set all logs globally.
A major use case is having release and debug modes with different log levels.</p>
<h3 id="adding-our-own-logging"><a class="header" href="#adding-our-own-logging">Adding our own logging</a></h3>
<p>Ok, so let's add in our own startup warning message, warning because only they and errors will show.
We can print a <code>Warn</code> message using Tracing's supplied macros</p>
<pre><code class="language-rust">fn setup(
    mut commands: Commands,
    mut meshes: ResMut&lt;Assets&lt;Mesh&gt;&gt;,
    mut materials: ResMut&lt;Assets&lt;StandardMaterial&gt;&gt;,
) {
    warn!("Hello Log");
    // Camera
    commands.spawn(Camera3dBundle {
        transform: Transform::from_xyz(0.0, 50.0, 100.0).looking_at(Vec3::ZERO, Vec3::Y),
        ..default()
    });
</code></pre>
<p>The output is</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T22:06:51.489315Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:06:51.499177Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:06:51.499190Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x61ce04f0ff20, name: ?)    
2024-10-19T22:06:51.506179Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:06:51.506193Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-19T22:06:52.007886Z  WARN test_spiral: Hello Log

</code></pre>
<p>Great. We can put a message there, but it's not really a warning, so we can move it to the info level.</p>
<p>We use Tracing's <code>info!</code> macro</p>
<p><code>info!("Hello Log")</code></p>
<p>Now let's run</p>
<pre><code>
     Running `target/debug/test_spiral`
2024-10-19T22:08:28.501325Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:08:28.511056Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:08:28.511070Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x63e8b387ee10, name: ?)    
2024-10-19T22:08:28.518035Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:08:28.518049Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively  
</code></pre>
<p>Perhaps unsurprisingly, The message did not appear as it is at a higher level than <code>warning</code>.
Therefore, our settings have declared this to be too verbose.</p>
<h3 id="higher-level-logging-for-our-application"><a class="header" href="#higher-level-logging-for-our-application">Higher level logging for our application</a></h3>
<p>First, let's add the depenencies</p>
<p><code>cargo add tracing</code></p>
<p><code>cargo add tracing-subscriber</code></p>
<p>In order to show our applications logging, we need to change the env filter to show our applications at the <code>info</code> level or above.</p>
<p>The syntax introduced will be to change targets</p>
<p><code>cratename::modulename</code></p>
<p>I called my example crate test_spiral</p>
<p>So, the target we supply to the env filter will be <code>test_spiral</code>. Since there is no module name, it is left blank.</p>
<p>Env filters are comma separated so <code>warn,test_spiral=info</code> will mean "run <code>warn</code> level for as normal, for module test_spiral <code>info</code>"</p>
<pre><code class="language-rust">fn main() {
    App::new()
        //Disable the defaults
        .add_plugins(DefaultPlugins.set(LogPlugin {
            filter: "warn,test_spiral=info".to_string(),
            level: Level::TRACE,
            ..Default::default()
        }))
        .add_systems(Startup, setup)
        .run();
}</code></pre>
<p>Let's run</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T22:12:21.298476Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:12:21.307716Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:12:21.307730Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x57003740c3c0, name: ?)    
2024-10-19T22:12:21.314793Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:12:21.314807Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-19T22:12:21.812880Z  INFO test_spiral: Hello Log
</code></pre>
<p>Excellent</p>
<h3 id="module"><a class="header" href="#module">Module</a></h3>
<p>We are going to make a second module we will keep it in the same file for simplicity but it will work for separate files</p>
<pre><code class="language-rust">use bevy::{log::LogPlugin, prelude::*};
use rand::prelude::*;
use tracing::Level;

fn main() {
    App::new()
        .add_plugins(DefaultPlugins.set(LogPlugin {
            filter: "warn,test_spiral=info".to_string(),
            level: Level::TRACE,
            ..Default::default()
        }))
        .add_systems(Startup, setup)
        .add_systems(Startup, spammy::print_trash)
        .run();
}

fn setup(
    mut commands: Commands,
    mut meshes: ResMut&lt;Assets&lt;Mesh&gt;&gt;,
    mut materials: ResMut&lt;Assets&lt;StandardMaterial&gt;&gt;,
) {
    info!("Hello Log");
    // Camera
    commands.spawn(Camera3dBundle {
        transform: Transform::from_xyz(0.0, 50.0, 100.0).looking_at(Vec3::ZERO, Vec3::Y),
        ..default()
    });

    // Light
    commands.spawn(PointLightBundle {
        point_light: PointLight {
            intensity: 1500.0,
            shadows_enabled: true,
            ..default()
        },
        transform: Transform::from_xyz(4.0, 8.0, 4.0),
        ..default()
    });

    let mut rng = rand::thread_rng();

    // Create spiral galaxy
    for i in 0..10000 {
        let t = i as f32 * 0.005;
        let r = 20.0 * t.sqrt();
        let theta = t * 2.5;

        let x = r * theta.cos();
        let z = r * theta.sin();
        let y = (rng.gen::&lt;f32&gt;() - 0.5) * 2.0; // Add some vertical spread

        let size = (0.05 + rng.gen::&lt;f32&gt;() * 0.1) * (1.0 - t / 50.0); // Smaller stars towards the edge
        let brightness = 1.0 - t / 50.0; // Dimmer stars towards the edge

        let color = Color::srgb(brightness, brightness * 0.8 + 0.2, brightness * 0.6 + 0.4);
        let emissive = Color::srgb(
            brightness * 5.0,
            (brightness * 0.8 + 0.2) * 5.0,
            (brightness * 0.6 + 0.4) * 5.0,
        );

        commands.spawn(PbrBundle {
            mesh: meshes.add(Mesh::from(Sphere { radius: size })),
            material: materials.add(StandardMaterial {
                base_color: color,
                emissive: emissive.into(), // Make stars glow
                ..default()
            }),
            transform: Transform::from_xyz(x, y, z),
            ..default()
        });
    }
}

mod spammy {
    use tracing::{debug, trace};

    pub fn print_trash() {
        debug!("I am going to print trash");
        for i in 0..10 {
            trace!(?i);
        }
    }
}</code></pre>
<p><code>?i</code> just means use debug of that variable to print. Otherwise you can use the macros the same way as <code>println!</code></p>
<p>Let's first change the log level for our application to be at <code>trace</code></p>
<pre><code class="language-rust">filter: "warn,test_spiral=trace".to_string(),</code></pre>
<p>now run</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T22:24:05.510403Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:24:05.520203Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:24:05.520217Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x59c6f223c5c0, name: ?)    
2024-10-19T22:24:05.527234Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:24:05.527248Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-19T22:24:06.016182Z DEBUG test_spiral::spammy: I am going to print trash
2024-10-19T22:24:06.016204Z TRACE test_spiral::spammy: i=0
2024-10-19T22:24:06.016210Z TRACE test_spiral::spammy: i=1
2024-10-19T22:24:06.016206Z  INFO test_spiral: Hello Log
2024-10-19T22:24:06.016215Z TRACE test_spiral::spammy: i=2
2024-10-19T22:24:06.016225Z TRACE test_spiral::spammy: i=3
2024-10-19T22:24:06.016230Z TRACE test_spiral::spammy: i=4
2024-10-19T22:24:06.016234Z TRACE test_spiral::spammy: i=5
2024-10-19T22:24:06.016238Z TRACE test_spiral::spammy: i=6
2024-10-19T22:24:06.016243Z TRACE test_spiral::spammy: i=7
2024-10-19T22:24:06.016247Z TRACE test_spiral::spammy: i=8
2024-10-19T22:24:06.016251Z TRACE test_spiral::spammy: i=9
</code></pre>
<p>In this case, you can see that the <code>print_trash</code> module ran before my setup code.
Also note that the crate module path was printed <code>test_spiral::spammy</code>. This will soon be relevant</p>
<h4 id="filter-out-by-module"><a class="header" href="#filter-out-by-module">Filter out by module</a></h4>
<p>Clearly we have a problem with spammy. We could just delete the spammy logs like we would have to do with techniques in the previous chapter.
However, for the sake of the excercie, let's pretend that we sometimes is useful.</p>
<p>Let's put in a log code so we cannot just change the application's logging levels</p>
<pre><code class="language-rust">fn setup(
    mut commands: Commands,
    mut meshes: ResMut&lt;Assets&lt;Mesh&gt;&gt;,
    mut materials: ResMut&lt;Assets&lt;StandardMaterial&gt;&gt;,
) {
    info!("Hello Log");
    debug!("Don't hide me");</code></pre>
<p>How do we just hide spammy's messages?</p>
<p>We do it like so, using the path that was printed <code>test_spiral::spammy</code></p>
<pre><code class="language-rust">filter: "warn,test_spiral=trace,test_spiral::spammy=info".to_string(),
</code></pre>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T22:32:16.697718Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:32:16.707200Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:32:16.707214Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x55916143c550, name: ?)    
2024-10-19T22:32:16.714329Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:32:16.714344Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-19T22:32:17.218967Z  INFO test_spiral: Hello Log
2024-10-19T22:32:17.218988Z DEBUG test_spiral: Don't hide me
</code></pre>
<p>If a log does not appear as I think it should, I usually just put it as an <code>error</code> and copy the path.</p>
<p>We can now selectively hide messages when we need to! This exciting idea is what lead me to learning more about the tracing crate.</p>
<p>But what about showing line numbers and extra details? This will be covered in the next chapter.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-to-tracing"><a class="header" href="#introduction-to-tracing">Introduction to Tracing</a></h1>
<h2 id="about-tracing"><a class="header" href="#about-tracing">About Tracing</a></h2>
<p><a href="https://crates.io/crates/tracing">Tracing</a>  <code>tracing</code> is a framework for instrumenting Rust programs to collect structured, event-based diagnostic information."</p>
<p>Tracing is made for and often talked about in regards to asynchronous code, which is where a lot of documentation and discussion is addresses.</p>
<p>However, you don't need to use async code to benefit from this crate. I expect I will use this crate for every non-trivial program I write in Rust!</p>
<h2 id="why-use-tracing"><a class="header" href="#why-use-tracing">Why use Tracing</a></h2>
<ul>
<li>Instead of deleting logs that you are not actively using, you can stop sending those logs until they are needed.</li>
<li>You can log to multiple files by category</li>
</ul>
<h2 id="next-steps-from-what-we-have-learned"><a class="header" href="#next-steps-from-what-we-have-learned">Next Steps from what we have learned</a></h2>
<p>So far, we have learned about logging levels and filtering by module. Our next goal is to learn how to add more context to our logs.</p>
<h3 id="instrument"><a class="header" href="#instrument">instrument</a></h3>
<p><code>instrument</code> adds more context to your functions</p>
<pre><code class="language-rust">
use bevy::{log::LogPlugin, prelude::*};
use rand::prelude::*;
use tracing::Level;

fn main() {
    App::new()
        .add_plugins(DefaultPlugins.set(LogPlugin {
            filter: "warn,test_spiral=trace,test_spiral::spammy=info".to_string(),
            level: Level::TRACE,
            ..Default::default()
        }))
        .add_systems(Startup, setup)
        .add_systems(Startup, spammy::print_trash)
        .run();
}

fn setup(
    mut commands: Commands,
    mut meshes: ResMut&lt;Assets&lt;Mesh&gt;&gt;,
    mut materials: ResMut&lt;Assets&lt;StandardMaterial&gt;&gt;,
) {
    info!("Hello Log");
    debug!("Don't hide me");
    // Camera
    commands.spawn(Camera3dBundle {
        transform: Transform::from_xyz(0.0, 50.0, 100.0).looking_at(Vec3::ZERO, Vec3::Y),
        ..default()
    });

    // Light
    commands.spawn(PointLightBundle {
        point_light: PointLight {
            intensity: 1500.0,
            shadows_enabled: true,
            ..default()
        },
        transform: Transform::from_xyz(4.0, 8.0, 4.0),
        ..default()
    });

    let mut rng = rand::thread_rng();

    // Create spiral galaxy
    for i in 0..10000 {
        let t = i as f32 * 0.005;
        let r = 20.0 * t.sqrt();
        let theta = t * 2.5;

        let x = r * theta.cos();
        let z = r * theta.sin();
        let y = (rng.gen::&lt;f32&gt;() - 0.5) * 2.0; // Add some vertical spread

        let size = (0.05 + rng.gen::&lt;f32&gt;() * 0.1) * (1.0 - t / 50.0); // Smaller stars towards the edge
        let brightness = 1.0 - t / 50.0; // Dimmer stars towards the edge

        let color = Color::srgb(brightness, brightness * 0.8 + 0.2, brightness * 0.6 + 0.4);
        let emissive = Color::srgb(
            brightness * 5.0,
            (brightness * 0.8 + 0.2) * 5.0,
            (brightness * 0.6 + 0.4) * 5.0,
        );

        commands.spawn(PbrBundle {
            mesh: meshes.add(Mesh::from(Sphere { radius: size })),
            material: materials.add(StandardMaterial {
                base_color: color,
                emissive: emissive.into(), // Make stars glow
                ..default()
            }),
            transform: Transform::from_xyz(x, y, z),
            ..default()
        });
    }
}

mod spammy {
    use tracing::{debug, info, instrument, trace};

    pub fn print_trash() {
        debug!("I am going to print trash");
        for i in 0..10 {
            trace!(?i);
            some_function(i);
        }
    }
    #[instrument]
    fn some_function(i: u8) {
        if i == 3 {
            info!("Fizz");
        }
    }
}</code></pre>
<p>Of particular note is <code>instrument</code></p>
<pre><code class="language-rust">#[instrument]
    fn some_function(i: u8) {
        if i == 3 {
            info!("Fizz");
        }
    }</code></pre>
<p>Let's run</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T22:42:47.680435Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:42:47.690495Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:42:47.690509Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x56938d752410, name: ?)    
2024-10-19T22:42:47.697443Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:42:47.697458Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-19T22:42:48.169391Z  INFO test_spiral: Hello Log
2024-10-19T22:42:48.169411Z DEBUG test_spiral: Don't hide me
2024-10-19T22:42:48.169448Z  INFO some_function{i=3}: test_spiral::spammy: Fizz
</code></pre>
<p>Notice that <code>some_function</code> is now printing along with its argument some more context.</p>
<p>We can skip the arguments using <code>skip_all</code>, which can be useful if some arguments don't implement <code>Debug</code>.</p>
<p><code>#[instrument(skip_all)]</code></p>
<p>I tend to use <code>skip_all</code> for all my systems as queries can be quite spammy.
If I, for example, create a system to query all transforms</p>
<p><code>.add_systems(Update, some_queries.run_if(run_once()))</code></p>
<pre><code class="language-rust">#[instrument]
fn some_queries(transformers: Query&lt;&amp;Transform&gt;) {
    info!("not actually going to run");
}</code></pre>
<p>The output gets quite verbose per query.</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T22:49:03.036115Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T22:49:03.046122Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T22:49:03.046136Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x57ca2fa1e580, name: ?)    
2024-10-19T22:49:03.053094Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T22:49:03.053108Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-19T22:49:03.537979Z  INFO setup: test_spiral: Hello Log
2024-10-19T22:49:03.538003Z DEBUG setup: test_spiral: Don't hide me
2024-10-19T22:49:03.537998Z  INFO some_function{i=3}: test_spiral::spammy: Fizz
2024-10-19T22:49:04.866039Z  INFO some_queries{transformers=Query 
{ matched_entities: 10002, state: QueryState { world_id: WorldId(0), matched_table_count: 3, matched_archetype_count: 3, .. }, 
last_run: Tick { tick: 1036800056 }, this_run: Tick { tick: 57 }, 
world: World { id: WorldId(0), entity_count: 10003, archetype_count: 8, component_count: 239, resource_count: 190 } }}: 
test_spiral: not actually going to run
</code></pre>
<p>Note I added the line breaks to fit the margins</p>
<p>So let's add <code>skip_all</code><br />
<code>#[instrument(skip_all)]</code></p>
<p>The output</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-21T08:12:11.871245Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-21T08:12:11.880725Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-21T08:12:11.880740Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x56a5fc78b4c0, name: ?)    
2024-10-21T08:12:11.887924Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-21T08:12:11.887939Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-21T08:12:12.345086Z  INFO test_spiral: Hello Log
2024-10-21T08:12:12.345107Z DEBUG test_spiral: Don't hide me
2024-10-21T08:12:12.345155Z  INFO some_function{i=3}: test_spiral::spammy: Fizz
2024-10-21T08:12:13.653510Z  INFO some_queries: test_spiral: not actually going to run
</code></pre>
<p>If you recall, an earlier section of the book says to equate targets with modules <em>for now</em>.</p>
<p>You can change that using arguments to instruments. This will not be demonstrated, however,
as I have never had a need for it yet.</p>
<p>More about instruments <a href="https://docs.rs/tracing/latest/tracing/attr.instrument.html">here</a></p>
<h3 id="spans"><a class="header" href="#spans">Spans</a></h3>
<p>I think of spans as tags, I don't have a lot of experience with them so this will be brief and incomplete.</p>
<p>My main use case for tags is grouping structually unrelated code that has a common theme such as timing or system type.</p>
<p>The examples for me are</p>
<ul>
<li>Startup systems</li>
<li>Yearly or montly systems in my stratergy games</li>
<li>Related ui or input handling</li>
</ul>
<p>You can use as many spans as you want.</p>
<p>Now lets look at the syntax to use a span inside a fuction.
You need code that looks like this</p>
<pre><code class="language-rust">let span = span!(Level::DEBUG, "start");
let _guard = span.enter();</code></pre>
<p>Spans only apply when the logging level is set at it or above.</p>
<p>Note <code>_guard</code> is there to stop the variable being dropped immediately.
The underscore is to stop unused errors as its drop behaviour is what really makes it work!</p>
<p>While <code>_guard</code> is valid(undropped) the span is entered.
While <code>span</code> is valid the span is created.</p>
<p>There are shorthands for all logging levels, such as <code>trace_span!</code></p>
<p>You cannot combine the <code>span(/* snip*/).enter</code>  into one line as <em>entering</em> a span and <em>creating</em>
are distinct things. A span is only <em>created</em> once while a span can be <em>entered</em> many times.</p>
<p>Entering and exiting spans is <del>stuff I don't have much idea about</del> beyond the scope this tutorial(mostly async stuff).</p>
<p>Spans <em>exit</em> when the variable holding the enter is dropped in this example the <code>_guard</code>
spans <em>close</em> when the span variable is dropped.</p>
<p>We can use square brackets to filter by span</p>
<p><code>filter: "warn,test_spiral=trace,test_spiral::spammy=info,test_spiral[start]=trace"</code></p>
<p>Now for the entire code</p>
<pre><code class="language-rust">use bevy::{log::LogPlugin, prelude::*};
use rand::prelude::*;
use tracing::{instrument, span, Level};

fn main() {
    App::new()
        .add_plugins(
            DefaultPlugins.set(LogPlugin {
                filter: "warn,test_spiral=debug,test_spiral::spammy=info,test_spiral[start]=trace"
                    .to_string(),
                level: Level::TRACE,
                ..Default::default()
            }),
        )
        .add_systems(Startup, setup)
        .add_systems(Startup, spammy::print_trash)
        .add_systems(Update, some_queries.run_if(run_once()))
        .run();
}

#[instrument(skip_all)]
fn setup(
    mut commands: Commands,
    mut meshes: ResMut&lt;Assets&lt;Mesh&gt;&gt;,
    mut materials: ResMut&lt;Assets&lt;StandardMaterial&gt;&gt;,
) {
    let span = span!(Level::DEBUG, "start");
    let _guard = span.enter();

    info!("Hello Log");
    debug!("Don't hide me");
    // Camera
    commands.spawn(Camera3dBundle {
        transform: Transform::from_xyz(0.0, 50.0, 100.0).looking_at(Vec3::ZERO, Vec3::Y),
        ..default()
    });

    // Light
    commands.spawn(PointLightBundle {
        point_light: PointLight {
            intensity: 1500.0,
            shadows_enabled: true,
            ..default()
        },
        transform: Transform::from_xyz(4.0, 8.0, 4.0),
        ..default()
    });

    let mut rng = rand::thread_rng();

    // Create spiral galaxy
    for i in 0..10000 {
        let t = i as f32 * 0.005;
        let r = 20.0 * t.sqrt();
        let theta = t * 2.5;

        let x = r * theta.cos();
        let z = r * theta.sin();
        let y = (rng.gen::&lt;f32&gt;() - 0.5) * 2.0; // Add some vertical spread

        let size = (0.05 + rng.gen::&lt;f32&gt;() * 0.1) * (1.0 - t / 50.0); // Smaller stars towards the edge
        let brightness = 1.0 - t / 50.0; // Dimmer stars towards the edge

        let color = Color::srgb(brightness, brightness * 0.8 + 0.2, brightness * 0.6 + 0.4);
        let emissive = Color::srgb(
            brightness * 5.0,
            (brightness * 0.8 + 0.2) * 5.0,
            (brightness * 0.6 + 0.4) * 5.0,
        );

        commands.spawn(PbrBundle {
            mesh: meshes.add(Mesh::from(Sphere { radius: size })),
            material: materials.add(StandardMaterial {
                base_color: color,
                emissive: emissive.into(), // Make stars glow
                ..default()
            }),
            transform: Transform::from_xyz(x, y, z),
            ..default()
        });
    }
}

#[instrument(skip_all)]
fn some_queries(transformers: Query&lt;&amp;Transform&gt;) {
    info!("not actually going to run");
    trace!("shouldn't appear");
}

mod spammy {
    use tracing::{debug, info, instrument, span, trace, Level};

    pub fn print_trash() {
        let span = span!(Level::DEBUG, "start");
        let _guard = span.enter();

        debug!("I am going to print trash");
        for i in 0..10 {
            trace!(?i);
            some_function(i);
        }
    }
    #[instrument]
    fn some_function(i: u8) {
        if i == 3 {
            info!("Fizz");
        }
    }
}
</code></pre>
<p>The output</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-19T23:11:16.601564Z  WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation    
2024-10-19T23:11:16.611283Z  WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.    
2024-10-19T23:11:16.611297Z  WARN wgpu_hal::vulkan::instance:   objects: (type: INSTANCE, hndl: 0x5662f0635080, name: ?)    
2024-10-19T23:11:16.618229Z  WARN wgpu_hal::gles::egl: No config found!    
2024-10-19T23:11:16.618243Z  WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively    
2024-10-19T23:11:17.119600Z DEBUG start: test_spiral::spammy: I am going to print trash
2024-10-19T23:11:17.119605Z  INFO setup:start: test_spiral: Hello Log
2024-10-19T23:11:17.119626Z TRACE start: test_spiral::spammy: i=0
2024-10-19T23:11:17.119633Z DEBUG setup:start: test_spiral: Don't hide me
2024-10-19T23:11:17.119652Z TRACE start: test_spiral::spammy: i=1
2024-10-19T23:11:17.119665Z TRACE start: test_spiral::spammy: i=2
2024-10-19T23:11:17.119678Z TRACE start: test_spiral::spammy: i=3
2024-10-19T23:11:17.119688Z  INFO start:some_function{i=3}: test_spiral::spammy: Fizz
2024-10-19T23:11:17.119698Z TRACE start: test_spiral::spammy: i=4
2024-10-19T23:11:17.119711Z TRACE start: test_spiral::spammy: i=5
2024-10-19T23:11:17.119723Z TRACE start: test_spiral::spammy: i=6
2024-10-19T23:11:17.119736Z TRACE start: test_spiral::spammy: i=7
2024-10-19T23:11:17.119748Z TRACE start: test_spiral::spammy: i=8
2024-10-19T23:11:17.119760Z TRACE start: test_spiral::spammy: i=9
2024-10-19T23:11:18.441500Z  INFO some_queries: test_spiral: not actually going to run
</code></pre>
<h2 id="using-tracing-on-its-own"><a class="header" href="#using-tracing-on-its-own">Using Tracing on its own</a></h2>
<p>For the sake of learning we will disable the default plugin and use the <code>tracing</code> crate itself.
This also means you can use what you learned here on other applications using <code>tracing</code>.
Tracing uses a subscriber made up of layers (I don't really understand the details)</p>
<pre><code class="language-rust">use bevy::{log::LogPlugin, prelude::*};
use rand::prelude::*;
use tracing::{instrument, span, Level};

fn main() {
    tracing_subscriber::fmt().init();

    App::new()
        //Disable the defaults
        .add_plugins(DefaultPlugins.build().disable::&lt;LogPlugin&gt;())
        .add_systems(Startup, setup)
        .add_systems(Startup, spammy::print_trash)
        .add_systems(Update, some_queries.run_if(run_once()))
        .run();
}</code></pre>
<p>Let's modify Tracing</p>
<pre><code class="language-rust">tracing_subscriber::fmt()
  .without_time()
  .with_file(true)
  .with_line_number(true)
  .pretty()
  .with_env_filter(
      EnvFilter::from_str(
          "warn,test_spiral=debug,test_spiral::spammy=info,test_spiral[start]=trace",
      )
      .unwrap(),
  )
  .init();
</code></pre>
<ul>
<li>
<p>I find timestamp is spammy with diff files so thats why <code>without_time</code> is there.</p>
</li>
<li>
<p>I mentioned that <code>dbg!</code> had line numbers and file names, <code>with_file(true)</code>,<code>with_line_numbers(true)</code>.</p>
</li>
<li>
<p>Pretty is useful for console, remove if you are redirecting to a txt file</p>
</li>
</ul>
<p>Now, let's run</p>
<pre><code>     Running `target/debug/test_spiral`
   WARN wgpu_hal::vulkan::instance: InstanceFlags::VALIDATION requested, but unable to find layer: VK_LAYER_KHRONOS_validation
    at /home/lyndonm/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wgpu-hal-0.21.1/src/vulkan/instance.rs:724

   WARN wgpu_hal::vulkan::instance: GENERAL [Loader Message (0x0)]
        terminator_CreateInstance: Failed to CreateInstance in ICD 4.  Skipping ICD.
    at /home/lyndonm/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wgpu-hal-0.21.1/src/vulkan/instance.rs:89

   WARN wgpu_hal::vulkan::instance:     objects: (type: INSTANCE, hndl: 0x5fb6876377c0, name: ?)
    at /home/lyndonm/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wgpu-hal-0.21.1/src/vulkan/instance.rs:148

   WARN wgpu_hal::gles::egl: No config found!
    at /home/lyndonm/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wgpu-hal-0.21.1/src/gles/egl.rs:269

   WARN wgpu_hal::gles::egl: EGL says it can present to the window but not natively
    at /home/lyndonm/.cargo/registry/src/index.crates.io-6f17d22bba15001f/wgpu-hal-0.21.1/src/gles/egl.rs:258

  DEBUG test_spiral::spammy: I am going to print trash
    at src/main.rs:107
    in test_spiral::spammy::start

   INFO test_spiral: Hello Log
    at src/main.rs:40
    in test_spiral::start
    in test_spiral::setup

  TRACE test_spiral::spammy: i: 0
    at src/main.rs:109
    in test_spiral::spammy::start

  DEBUG test_spiral: Don't hide me
    at src/main.rs:41
    in test_spiral::start
    in test_spiral::setup

  TRACE test_spiral::spammy: i: 1
    at src/main.rs:109
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 2
    at src/main.rs:109
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 3
    at src/main.rs:109
    in test_spiral::spammy::start

   INFO test_spiral::spammy: Fizz
    at src/main.rs:116
    in test_spiral::spammy::some_function with i: 3
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 4
    at src/main.rs:109
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 5
    at src/main.rs:109
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 6
    at src/main.rs:109
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 7
    at src/main.rs:109
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 8
    at src/main.rs:109
    in test_spiral::spammy::start

  TRACE test_spiral::spammy: i: 9
    at src/main.rs:109
    in test_spiral::spammy::start

   INFO test_spiral: not actually going to run
    at src/main.rs:96
    in test_spiral::some_queries
</code></pre>
<p>Line numbers and file names. You may be happy to just work on your game from this point.
Next chapters is basically breaking Tracing up into layers so you can have multiple specialized files.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tracing-multiple-files"><a class="header" href="#tracing-multiple-files">Tracing multiple files</a></h1>
<p>Using our powers of span, we can "Tag" our logs to go to separate files per span. First, we need to learn about layers.</p>
<h2 id="subscribers"><a class="header" href="#subscribers">Subscribers</a></h2>
<p>Subscribers carry many layers. I am not entirely sure about the definition of a subscriber, but I believe it's basically
a consumer of tracing logs that decides how to output them. I have only used the one on the tracing crate,
but there are other variations, such as tree logging.</p>
<p>Let's read the documentation
"A subscriber is responsible for the following:</p>
<pre><code>Registering new spans as they are created, and providing them with span IDs. Implicitly, this means the subscriber may determine the strategy for determining span equality.
Recording the attachment of field values and follows-from annotations to spans.
Filtering spans and events, and determining when those filters must be invalidated.
Observing spans as they are entered, exited, and closed, and events as they occur.
</code></pre>
<p>"</p>
<h2 id="layers"><a class="header" href="#layers">Layers</a></h2>
<p>I will just start with an example.</p>
<pre><code class="language-rust">let stdout_layer = tracing_subscriber::fmt::layer()
    .with_line_number(true)
    .with_file(true)
    .without_time()
    .pretty()
    /* Put less important stuff info files */
    .with_filter(EnvFilter::from_str("warn,test_spiral=info").unwrap());</code></pre>
<p>Layers do the presentation and filtering of data, in the example above this sends data to the standard output.</p>
<pre><code class="language-rust">let log_file = File::create("logs/start.log").unwrap();
let start_layer = tracing_subscriber::fmt::layer()
    .with_line_number(true)
    .with_file(true)
    .without_time()
    .with_ansi(false)
    .with_writer(Mutex::new(log_file))
    .with_filter(EnvFilter::from_str("none,test_spiral::[start]=trace").unwrap());</code></pre>
<p>This above layer will send the file to a file by output log based on all spans that have start</p>
<p>we can add them as below, just above your main application,</p>
<pre><code class="language-rust">//code for layers above
tracing_subscriber::registry()
    .with(stdout_layer)
    .with(start_layer)
    .init();

    App::new()
        //Disable the defaults
        .add_plugins(DefaultPlugins.build().disable::&lt;LogPlugin&gt;())
        .add_systems(Startup, setup)
        .add_systems(Startup, spammy::print_trash)
        .add_systems(Update, some_queries.run_if(run_once()))
        .run();
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="putting-layers-in-you-default-plugin"><a class="header" href="#putting-layers-in-you-default-plugin">Putting layers in you default plugin</a></h1>
<p>TODO: I am getting errors trying to do achieve this</p>
<p>I have got logging working as expected via previous techniques so this is not a high priority for me.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="other-features-i-have-thought-of-using"><a class="header" href="#other-features-i-have-thought-of-using">Other features I have thought of using</a></h1>
<h2 id="filtering-logs-by-value"><a class="header" href="#filtering-logs-by-value">Filtering logs by value</a></h2>
<p>Lets say an argument or a variable when set to a certain value is causing issues.
I think you can use {field=value} with field being the variable name.
I have not however tested this or used this yet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="further-info"><a class="header" href="#further-info">Further Info</a></h1>
<p>You have reached the limit of my undestanding with Tracing useful links below.</p>
<p><a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/index.html">Docs on the subscriber crate</a></p>
<p>I had never heard of Tracing prior to this video.
This video spends a lot more time covering the details especially around layers.
It also covers async
<a href="https://www.youtube.com/watch?v=21rtHinFA40">Jon Gjengset "decrusting" tracing</a></p>
<p><a href="https://rust-exercises.com/telemetry/">Another tutorial</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-patterns"><a class="header" href="#design-patterns">Design patterns</a></h1>
<h2 id="log-let-else-queries"><a class="header" href="#log-let-else-queries">Log let else queries</a></h2>
<p>The typical quick way when prototyping queries with only one expected item is to just use <code>unwrap</code></p>
<p>However a slighter better option is to use <code>let else</code> statements.</p>
<p>lets start with an example</p>
<p>based on our code <a href="https://github.com/bevy-logging/test_spiral">here.</a></p>
<pre><code class="language-rust">
use std::str::FromStr;

use bevy::{log::LogPlugin, prelude::*};
use rand::prelude::*;

fn main() {
    App::new()
        //Disable the defaults
        .add_plugins(DefaultPlugins)
        .add_systems(Startup, setup)
        .add_systems(Startup, spammy::print_trash)
        .add_systems(Update, some_queries.run_if(run_once()))
        .add_systems(Update, query_light.run_if(run_once()))
        .run();
}

fn setup(
    mut commands: Commands,
    mut meshes: ResMut&lt;Assets&lt;Mesh&gt;&gt;,
    mut materials: ResMut&lt;Assets&lt;StandardMaterial&gt;&gt;,
) {
    // Camera
    commands.spawn(Camera3dBundle {
        transform: Transform::from_xyz(0.0, 50.0, 100.0).looking_at(Vec3::ZERO, Vec3::Y),
        ..default()
    });

    // Light
    // commands.spawn(PointLightBundle {
    //     point_light: PointLight {
    //         intensity: 1500.0,
    //         shadows_enabled: true,
    //         ..default()
    //     },
    //     transform: Transform::from_xyz(4.0, 8.0, 4.0),
    //     ..default()
    // });

    let mut rng = rand::thread_rng();

    // Create spiral galaxy
    for i in 0..10000 {
        let t = i as f32 * 0.005;
        let r = 20.0 * t.sqrt();
        let theta = t * 2.5;

        let x = r * theta.cos();
        let z = r * theta.sin();
        let y = (rng.gen::&lt;f32&gt;() - 0.5) * 2.0; // Add some vertical spread

        let size = (0.05 + rng.gen::&lt;f32&gt;() * 0.1) * (1.0 - t / 50.0); // Smaller stars towards the edge
        let brightness = 1.0 - t / 50.0; // Dimmer stars towards the edge

        let color = Color::srgb(brightness, brightness * 0.8 + 0.2, brightness * 0.6 + 0.4);
        let emissive = Color::srgb(
            brightness * 5.0,
            (brightness * 0.8 + 0.2) * 5.0,
            (brightness * 0.6 + 0.4) * 5.0,
        );

        commands.spawn(PbrBundle {
            mesh: meshes.add(Mesh::from(Sphere { radius: size })),
            material: materials.add(StandardMaterial {
                base_color: color,
                emissive: emissive.into(), // Make stars glow
                ..default()
            }),
            transform: Transform::from_xyz(x, y, z),
            ..default()
        });
    }
}

fn some_queries(transformers: Query&lt;&amp;Transform&gt;) {}

fn query_light(light_query: Query&lt;&amp;PointLight&gt;) {
    let light = light_query.get_single().unwrap();

    info!("found the light");
}

mod spammy {

    pub fn print_trash() {
        for i in 0..10 {
            some_function(i);
        }
    }
    fn some_function(i: u8) {
        if i == 3 {}
    }
}</code></pre>
<p>A query has been added for the pointlight but it no longer is created
we can see what happens</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-20T23:47:00.160263Z  INFO bevy_diagnostic::system_information_diagnostics_plugin::internal: SystemInfo { os: "Linux 22.04 KDE neon", kernel: "6.8.0-45-generic", cpu: "AMD Ryzen 7 7800X3D 8-Core Processor", core_count: "8", memory: "30.5 GiB" }
2024-10-20T23:47:00.274629Z  INFO bevy_render::renderer: AdapterInfo { name: "NVIDIA GeForce RTX 3070", vendor: 4318, device: 9348, device_type: DiscreteGpu, driver: "NVIDIA", driver_info: "535.183.01", backend: Vulkan }
2024-10-20T23:47:00.691667Z  INFO bevy_winit::system: Creating new window "App" (Entity { index: 0, generation: 1 })
2024-10-20T23:47:00.692031Z  INFO winit::platform_impl::linux::x11::window: Guessed window scale factor: 1
thread 'Compute Task Pool (3)' panicked at src/main.rs:77:42:
called `Result::unwrap()` on an `Err` value: NoEntities("bevy_ecs::query::state::QueryState&lt;&amp;bevy_pbr::light::point_light::PointLight&gt;")
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
Encountered a panic in system `test_spiral::query_light`!
Encountered a panic in system `bevy_app::main_schedule::Main::run_main`!
</code></pre>
<p>A crash its good we got the issue pointed out to us straight away but we could change
the query_light function to be as below.</p>
<pre><code class="language-rust">fn query_light(light_query: Query&lt;&amp;PointLight&gt;) {
    let light = light_query.get_single() else {
        error!("no light found");
        return;
    };

    info!("found the light");
}</code></pre>
<p>By stopping crashing but logging the issues we can keep the game going and possibly find
multiple issues in one run.</p>
<p>Plus if the system is not that vital, we don't need to ruin the user's experience.</p>
<pre><code>     Running `target/debug/test_spiral`
2024-10-20T23:53:21.775972Z  INFO bevy_diagnostic::system_information_diagnostics_plugin::internal: SystemInfo { os: "Linux 22.04 KDE neon", kernel: "6.8.0-45-generic", cpu: "AMD Ryzen 7 7800X3D 8-Core Processor", core_count: "8", memory: "30.5 GiB" }
2024-10-20T23:53:21.904099Z  INFO bevy_render::renderer: AdapterInfo { name: "NVIDIA GeForce RTX 3070", vendor: 4318, device: 9348, device_type: DiscreteGpu, driver: "NVIDIA", driver_info: "535.183.01", backend: Vulkan }
2024-10-20T23:53:22.316914Z  INFO bevy_winit::system: Creating new window "App" (Entity { index: 0, generation: 1 })
2024-10-20T23:53:22.317300Z  INFO winit::platform_impl::linux::x11::window: Guessed window scale factor: 1
2024-10-20T23:53:23.645988Z  INFO test_spiral: found the light
</code></pre>
<p>Prefer to use <code>continue</code> over return in loops otherwise one bad apple will destroy bunch</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="other-subscribers"><a class="header" href="#other-subscribers">Other Subscribers</a></h1>
<p>So far all that has been presented is the fmt subscriber for text output but Tracing can do more then that.
Note I haven't needed to use multiple subscribers, so far I just change globabl subscriber and leave it at that.</p>
<h2 id="bunyan-subscriber"><a class="header" href="#bunyan-subscriber">Bunyan Subscriber</a></h2>
<p>I don't know what bunyan the format is, just someone<sup class="footnote-reference"><a href="#note">1</a></sup> thought it was worth mentioning, who am I to disagree?
<a href="https://crates.io/crates/tracing-bunyan-formatter">bunyan</a></p>
<h2 id="gizmo-subscriber"><a class="header" href="#gizmo-subscriber">Gizmo Subscriber</a></h2>
<p>Use to draw gizmos quickly, I have not yet used but I am likely to in future.
I am interested in using Gizmos for debugging if I ever get to them, I will write about them.</p>
<p>My understanding of Gizmo's is</p>
<p>They are graphics drawn in immediate mode as opposed to retained;</p>
<p>Therefore they are not fast but can be use for marking places such as where your lights are, or testing rotations.</p>
<p>(Plans are for 0.16 to change this to retained, this is written just before 0.15)</p>
<p><a href="https://docs.rs/crate/bevy_gizmo_log/latest">Gizmo subscriber</a></p>
<div class="footnote-definition" id="note"><sup class="footnote-definition-label">1</sup>
<p>Thanks to Discord user ThierryBerger</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="performance"><a class="header" href="#performance">Performance</a></h1>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>I have not empirically measured any performance at all, so this is all a matter of if very obvious impacts.
If I do measure it later I will update it.</p>
<h2 id="logging-statements-runtime-ignored"><a class="header" href="#logging-statements-runtime-ignored">Logging statements runtime ignored</a></h2>
<p>I have not experienced any issues with just having lots of logging that is ignored at runtime.
It is possible to set levels at compile time, I haven't yet got around to doing it (that is why there is no instructions yet).
Tracing from what was said in Jon Gjensets video goes to great pains to minimise performance costs.</p>
<h2 id="logging-multiple-files"><a class="header" href="#logging-multiple-files">Logging multiple files.</a></h2>
<p>Previous chapters discussed how its possible to have files throughly recording everything you can possibly care about;
However I noticed massive performance gains just by commenting out the layers that print to the file.</p>
<h3 id="mitigating-the-perfomance-issues"><a class="header" href="#mitigating-the-perfomance-issues">Mitigating the perfomance issues.</a></h3>
<p>TODO: Test if I can somehow make an IO logging thread in bevy work with tracing.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>I welcome all contributions to the book whether it is via a pull request or raising an issue.</p>
<p><a href="https://github.com/bevy-logging/bevy_logging">Github</a></p>
<p>Ideally it would come with an example using the <a href="https://github.com/bevy-logging/test_spiral">test_spiral</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
